"use strict";const{app:c,BrowserWindow:$,screen:N,ipcMain:a,shell:O,Tray:D,Menu:R,nativeImage:S,clipboard:y,dialog:x}=require("electron"),{autoUpdater:f}=require("electron-updater"),d=require("node:path"),i=require("fs"),{exec:M}=require("child_process");c.commandLine.appendSwitch("autoplay-policy","no-user-gesture-required");let I=null,o=null,g=null,F=null;a.handle("get-update-status",()=>F);a.handle("set-ignore-mouse-events",(e,n,t)=>{o&&o.setIgnoreMouseEvents(n,{forward:t||!1})});a.handle("open-external",async(e,n)=>{await O.openExternal(n)});const P=()=>{try{const n="icon.png";if(c.isPackaged){const s=d.join(process.resourcesPath,n);if(i.existsSync(s))return s;const l=d.join(process.resourcesPath,"assets","icons",n);if(i.existsSync(l))return l}const t=c.getAppPath(),r=[d.join(t,"src","assets","icons",n),d.join(t,"assets","icons",n),d.join(__dirname,"assets","icons",n),d.join(__dirname,"..","src","assets","icons",n)];for(const s of r)try{if(i.existsSync(s))return s}catch(l){console.error(`[Main] Error checking path ${s}:`,l)}}catch(e){console.error("[Main] Error in getIconPath:",e)}},E=()=>{const e=N.getPrimaryDisplay(),{width:n,height:t}=e.size;o=new $({width:n,height:t,x:0,y:0,backgroundColor:"#00000000",transparent:!0,alwaysOnTop:!0,resizable:!1,frame:!1,thickFrame:!1,hasShadow:!1,skipTaskbar:!0,icon:P(),hiddenInMissionControl:!0,type:"toolbar",fullscreen:!1,visibleOnFullScreen:!0,webPreferences:{preload:d.join(__dirname,"preload.js"),devTools:!1},show:!1}),o.setAlwaysOnTop(!0,"screen-saver"),o.setVisibleOnAllWorkspaces(!0,{visibleOnFullScreen:!0}),o.setFullScreen(!0),o.setIgnoreMouseEvents(!0,{forward:!0});const r=0;o.once("ready-to-show",()=>{setTimeout(()=>{o&&(o.show(),o.focus())},r)}),setTimeout(()=>{o&&!o.isVisible()&&(o.show(),o.focus())},5e3),o.on("closed",()=>{o=null});try{o.setVisibleOnAllWorkspaces(!0,{visibleOnFullScreen:!0})}catch{}if(!c.isPackaged||process.env.NODE_ENV==="development")o.loadURL("http://localhost:5173");else{const s=d.join(__dirname,"../renderer/main_window/index.html");o.loadFile(s)}},W=()=>{if(g){g.focus();return}if(g=new $({width:500,height:600,title:"Island Settings",autoHideMenuBar:!0,icon:P(),webPreferences:{preload:d.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0}}),!c.isPackaged||process.env.NODE_ENV==="development")g.loadURL("http://localhost:5173/settings.html");else{const e=d.join(__dirname,"../renderer/main_window/settings.html");g.loadFile(e)}g.on("closed",()=>{g=null})};c.whenReady().then(()=>{if(!c.requestSingleInstanceLock()){x.showErrorBox("Island is already running","Another instance of Island is already running. Please close it first."),c.quit();return}E(),c.isPackaged&&(f.autoDownload=!0,f.autoInstallOnAppQuit=!0,f.setFeedURL({provider:"github",owner:"Ali120B",repo:"Island"}),f.checkForUpdatesAndNotify(),setInterval(()=>{f.checkForUpdatesAndNotify()},60*60*1e3),f.on("update-available",e=>{console.log("[Updater] Update available:",e.version),g&&g.webContents.send("update-available",e.version),o&&o.webContents.send("update-available",e.version)}),f.on("update-downloaded",e=>{console.log("[Updater] Update downloaded:",e.version),F=e,g&&g.webContents.send("update-downloaded",e.version),o&&o.webContents.send("update-downloaded",e.version)}),f.on("error",e=>{console.error("[Updater] Error:",e)})),c.on("activate",()=>{$.getAllWindows().length===0&&E()});try{const e=P();let n;e&&i.existsSync(e)?n=S.createFromPath(e).resize({width:16,height:16}):n=S.createEmpty();const t=R.buildFromTemplate([{label:"Show/Hide Island",click:()=>{o&&(o.isVisible()?o.hide():o.show())}},{label:"Settings",click:()=>{W()}},{type:"separator"},{label:"Quit",click:()=>{c.quit()}}]);I=new D(n),I.setToolTip("Island"),I.setContextMenu(t)}catch(e){console.error("Failed to create tray:",e)}});a.on("open-settings",()=>{W()});a.on("quit-and-install",()=>{f.quitAndInstall(!1,!0)});a.on("hide-island",()=>{try{o&&o.hide()}catch(e){console.error("[Main] Failed to hide island:",e)}});a.on("quit-app",()=>{try{c.quit()}catch(e){console.error("[Main] Failed to quit app:",e)}});a.handle("save-settings",async(e,n)=>{try{const t=d.join(c.getPath("documents"),"Island");i.existsSync(t)||i.mkdirSync(t,{recursive:!0});const r=d.join(t,"settings.json");return i.writeFileSync(r,JSON.stringify(n,null,2)),!0}catch(t){return console.error("Error saving settings:",t),!1}});a.handle("get-settings",async()=>{try{const e=d.join(c.getPath("documents"),"Island","settings.json");if(i.existsSync(e)){const n=i.readFileSync(e,"utf8");return JSON.parse(n)}}catch(e){console.error("Error getting settings:",e)}return{}});a.handle("change-volume",(e,n)=>(M(`powershell -NoProfile -Command "${`(New-Object -ComObject WScript.Shell).SendKeys(${n==="up"?"[char]175":"[char]174"})`}"`),null));a.handle("change-brightness",(e,n)=>new Promise(t=>{const s=`
$ErrorActionPreference = 'Stop'
$brightness = (Get-WmiObject -Namespace root/WMI -Class WmiMonitorBrightness).CurrentBrightness
$newBrightness = $brightness + ${n==="up"?10:-10}
if ($newBrightness -gt 100) { $newBrightness = 100 }
if ($newBrightness -lt 0) { $newBrightness = 0 }
(Get-WmiObject -Namespace root/WMI -Class WmiMonitorBrightnessMethods).WmiSetBrightness(1, $newBrightness) | Out-Null
Write-Output $newBrightness
`,l=d.join(c.getPath("userData"),"brightness-script.ps1");try{i.writeFileSync(l,s)}catch(u){return console.error("[Main] Failed to write brightness script:",u),t(null)}M(`powershell -NoProfile -ExecutionPolicy Bypass -File "${l}"`,{timeout:6e3},(u,w,p)=>{try{i.unlinkSync(l)}catch{}if(u)return console.error("[Main] change-brightness failed:",u.message),p&&console.error("[Main] change-brightness stderr:",p),t(null);const b=Number(String(w).trim());t(Number.isFinite(b)?b:null)})}));a.handle("select-file",async()=>{const e=await x.showOpenDialog({properties:["openFile"],filters:[{name:"Applications",extensions:["exe","lnk"]}]});return e.canceled?null:e.filePaths[0]});a.handle("open-app",async(e,n)=>{await O.openPath(n)});a.handle("get-app-icon",async(e,n)=>{try{return(await c.getFileIcon(n)).toDataURL()}catch(t){return console.error("Error getting icon:",t),null}});a.handle("save-todo",async(e,n)=>{try{const t=d.join(c.getPath("documents"),"Island");i.existsSync(t)||i.mkdirSync(t,{recursive:!0});const r=d.join(t,"todo.json");return i.writeFileSync(r,JSON.stringify(n,null,2)),!0}catch(t){return console.error("Error saving todo:",t),!1}});a.handle("get-todo",async()=>{try{const e=d.join(c.getPath("documents"),"Island","todo.json");if(i.existsSync(e)){const n=i.readFileSync(e,"utf8");return JSON.parse(n)}}catch(e){console.error("Error getting todo:",e)}return[]});a.handle("get-calendar-events",async()=>{try{const e=d.join(c.getPath("documents"),"Island","calendar-events.json");if(i.existsSync(e)){const n=i.readFileSync(e,"utf8");return JSON.parse(n)}}catch(e){console.error("Error getting calendar events:",e)}return{}});a.handle("save-calendar-events",async(e,n)=>{try{const t=d.join(c.getPath("documents"),"Island");i.existsSync(t)||i.mkdirSync(t,{recursive:!0});const r=d.join(t,"calendar-events.json");return i.writeFileSync(r,JSON.stringify(n,null,2)),!0}catch(t){return console.error("Error saving calendar events:",t),!1}});a.handle("log",(e,n)=>{console.log(`[Renderer]: ${n}`)});a.handle("get-system-media",async()=>new Promise(e=>{const n=`
$ErrorActionPreference = 'Stop'
try {
    # Load WinRT assemblies
    Add-Type -AssemblyName System.Runtime.WindowsRuntime
    [void][Windows.Media.Control.GlobalSystemMediaTransportControlsSessionManager,Windows.Media.Control,ContentType=WindowsRuntime]
    
    # Helper function to convert WinRT async to .NET Task
    $asTaskGeneric = ([System.WindowsRuntimeSystemExtensions].GetMethods() | Where-Object { 
        $_.Name -eq 'AsTask' -and 
        $_.GetParameters().Count -eq 1 -and 
        $_.GetParameters()[0].ParameterType.Name -eq 'IAsyncOperation\`1' 
    })[0]
    
    function Await($WinRtTask, $ResultType) {
        $asTask = $asTaskGeneric.MakeGenericMethod($ResultType)
        $netTask = $asTask.Invoke($null, @($WinRtTask))
        $netTask.Wait(-1) | Out-Null
        return $netTask.Result
    }
    
    # Get the session manager
    $asyncOp = [Windows.Media.Control.GlobalSystemMediaTransportControlsSessionManager]::RequestAsync()
    $manager = Await $asyncOp ([Windows.Media.Control.GlobalSystemMediaTransportControlsSessionManager])
    
    if (-not $manager) { Write-Output 'null'; exit 0 }
    
    # Find a playing session
    $sessions = $manager.GetSessions()
    $session = $null
    foreach ($s in $sessions) {
        $pb = $s.GetPlaybackInfo()
        if ($pb.PlaybackStatus -eq 'Playing') { $session = $s; break }
    }
    if (-not $session) { $session = $manager.GetCurrentSession() }
    if (-not $session) { Write-Output 'null'; exit 0 }
    
    # Get media properties
    $propsAsync = $session.TryGetMediaPropertiesAsync()
    $props = Await $propsAsync ([Windows.Media.Control.GlobalSystemMediaTransportControlsSessionMediaProperties])
    $pb = $session.GetPlaybackInfo()
    
    @{
        Title = if($props.Title) { $props.Title } else { 'Unknown' }
        Artist = if($props.Artist) { $props.Artist } else { '' }
        Album = if($props.AlbumTitle) { $props.AlbumTitle } else { '' }
        Status = $pb.PlaybackStatus.ToString().ToLower()
        Source = $session.SourceAppUserModelId
    } | ConvertTo-Json -Compress
} catch {
    Write-Host "PS Error: $_"
    Write-Output 'null'
}
`,t=d.join(c.getPath("userData"),"media-script.ps1");try{i.writeFileSync(t,n)}catch(l){return console.error("[Media] Failed to write script:",l),e(null)}const r=l=>{M("pwsh -Version",{timeout:2e3},u=>{l(!u)})},s=l=>{const u=l?"pwsh":"powershell";console.log(`[Media] Using ${u}...`),M(`${u} -NoProfile -ExecutionPolicy Bypass -File "${t}"`,{timeout:8e3},(w,p,b)=>{try{i.unlinkSync(t)}catch{}if(b&&console.log("[Media] Stderr:",b),p&&console.log("[Media] Output:",p.trim().substring(0,150)),w)return console.error("[Media] Error:",w.message),e(null);try{const T=p.trim().split(`
`).find(C=>C.trim().startsWith("{"));if(!T||T==="null")return console.log("[Media] No session found"),e(null);const m=JSON.parse(T);console.log("[Media] Found:",m.Title,"-",m.Artist);let v=m.Source||"System";v.includes(".")&&(v=v.split(".")[0]),e({name:m.Title||"Unknown Title",artist:m.Artist||"Unknown Artist",album:m.Album||"",state:m.Status==="playing"?"playing":"paused",source:v,artwork_url:null})}catch(A){console.error("[Media] Parse error:",A.message),e(null)}})};r(l=>s(l))}));c.on("window-all-closed",()=>{c.quit()});a.handle("write-files-to-clipboard",(e,n)=>{if(!n||!Array.isArray(n))return;const t=n.filter(s=>typeof s=="string"&&s.length>0);if(t.length===0){console.log("[Main]: No valid paths to write.");return}const r=t.map(s=>d.win32.normalize(s));console.log("[Main]: WRITING TO CLIPBOARD (filenames only):",r);try{y.clear(),y.write({filenames:r})}catch(s){console.error("[Main]: Clipboard error:",s)}});a.on("ondragstart",(e,n)=>{if(console.log(`[Main] Attempting dragstart for: ${n}`),i.existsSync(n)){const t=P();let r;t&&i.existsSync(t)&&(r=S.createFromPath(t),r.isEmpty()?r=void 0:r=r.resize({width:32,height:32}));const s=d.resolve(n);console.log(`[Main] Starting OS drag for REAL file: ${s}`);try{if(!i.existsSync(s))throw new Error(`File not found: ${s}`);c.getFileIcon(s,{size:"normal"}).then(l=>{const u=$.fromWebContents(e.sender);u&&(u.setIgnoreMouseEvents(!0,{forward:!1}),u.setAlwaysOnTop(!0,"floating")),e.sender.startDrag({file:s,icon:l}),console.log(`[Main] OS acknowledged REAL file drag for: ${s}`),e.sender.once("drag-end",()=>{console.log(`[Main] Drag ended for: ${s}`),u&&!u.isDestroyed()&&(u.setAlwaysOnTop(!0,"screen-saver"),u.setIgnoreMouseEvents(!1)),e.sender.send("drag-finished",n)})}).catch(l=>{console.error("[Main] Error getting file icon:",l);const u=P(),w=u&&i.existsSync(u)?S.createFromPath(u).resize({width:32,height:32}):S.createEmpty(),p=$.fromWebContents(e.sender);p&&(p.setIgnoreMouseEvents(!0,{forward:!1}),p.setAlwaysOnTop(!0,"floating")),e.sender.startDrag({file:s,files:[s],icon:w}),p&&!p.isDestroyed()&&(p.setAlwaysOnTop(!0,"screen-saver"),p.setIgnoreMouseEvents(!1)),e.sender.send("drag-finished",n)})}catch(l){console.error("[Main] Critical error during startDrag:",l)}}else console.error(`[Main] File does not exist for drag: ${n}`)});const k=()=>{const e=d.join(c.getPath("documents"),"Island","ai_chats");return i.existsSync(e)||i.mkdirSync(e,{recursive:!0}),d.join(e,"history.json")};a.handle("save-chat-history",async(e,n)=>{try{const t=k();let r=[];if(i.existsSync(t))try{const s=i.readFileSync(t,"utf8");r=JSON.parse(s)}catch(s){console.error("Error reading chat history:",s)}return r.push({id:Date.now().toString(),timestamp:Date.now(),...n}),i.writeFileSync(t,JSON.stringify(r,null,2)),!0}catch(t){return console.error("Error saving chat history:",t),!1}});a.handle("get-chat-history",async()=>{try{const e=k();if(i.existsSync(e)){const n=i.readFileSync(e,"utf8");return JSON.parse(n)}return[]}catch(e){return console.error("Error getting chat history:",e),[]}});a.handle("clear-chat-history",async()=>{try{const e=k();return i.existsSync(e)&&i.unlinkSync(e),!0}catch(e){return console.error("Error clearing chat history:",e),!1}});let h=[];const _=50,j=()=>{const e=y.readText(),n=y.readImage();let t=null;if(n.isEmpty())e&&e.trim()&&(h.length===0||h[0].content!==e)&&(t={type:"text",content:e,timestamp:Date.now()});else{const r=n.toDataURL();(h.length===0||h[0].content!==r)&&(t={type:"image",content:r,timestamp:Date.now()})}t&&(h.unshift(t),h.length>_&&h.pop(),o&&o.webContents.send("clipboard-update",h))};setInterval(j,1e3);a.handle("get-clipboard-history",()=>h);a.handle("copy-to-clipboard",(e,{type:n,content:t})=>{if(n==="image"){const r=S.createFromDataURL(t);y.writeImage(r)}else y.writeText(t);return j(),!0});a.handle("clear-clipboard-history",()=>(h=[],y.clear(),o&&o.webContents.send("clipboard-update",h),!0));a.handle("delete-clipboard-item",(e,n)=>{const t=h.find(r=>r.timestamp===n);if(t){const r=y.readText(),s=y.readImage();let l=!1;(t.type==="text"&&t.content===r||t.type==="image"&&!s.isEmpty()&&t.content===s.toDataURL())&&(l=!0),l&&y.clear()}return h=h.filter(r=>r.timestamp!==n),o&&o.webContents.send("clipboard-update",h),!0});
