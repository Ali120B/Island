"use strict";const{app:d,BrowserWindow:$,screen:x,ipcMain:l,shell:C,Tray:j,Menu:F,nativeImage:w,clipboard:y,dialog:N}=require("electron"),c=require("node:path"),o=require("fs");d.commandLine.appendSwitch("autoplay-policy","no-user-gesture-required");let v=null,i=null,m=null;const{exec:b}=require("child_process");l.handle("set-ignore-mouse-events",(e,n,t)=>{i&&i.setIgnoreMouseEvents(n,{forward:t||!1})});l.handle("open-external",async(e,n)=>{await C.openExternal(n)});const P=()=>{try{const n="icon.png";if(d.isPackaged){const r=c.join(process.resourcesPath,n);if(o.existsSync(r))return r;const a=c.join(process.resourcesPath,"assets","icons",n);if(o.existsSync(a))return a}const t=d.getAppPath(),s=[c.join(t,"src","assets","icons",n),c.join(t,"assets","icons",n),c.join(__dirname,"assets","icons",n),c.join(__dirname,"..","src","assets","icons",n)];for(const r of s)try{if(o.existsSync(r))return r}catch(a){console.error(`[Main] Error checking path ${r}:`,a)}}catch(e){console.error("[Main] Error in getIconPath:",e)}},k=()=>{const e=x.getPrimaryDisplay(),{width:n,height:t}=e.size;i=new $({width:n,height:t,x:0,y:0,backgroundColor:"#00000000",transparent:!0,alwaysOnTop:!0,resizable:!1,frame:!1,thickFrame:!1,hasShadow:!1,skipTaskbar:!0,icon:P(),hiddenInMissionControl:!0,type:"toolbar",fullscreen:!1,visibleOnFullScreen:!0,webPreferences:{preload:c.join(__dirname,"preload.js"),devTools:!1},show:!1}),i.setAlwaysOnTop(!0,"screen-saver"),i.setVisibleOnAllWorkspaces(!0,{visibleOnFullScreen:!0}),i.setFullScreen(!0),i.setIgnoreMouseEvents(!0,{forward:!0});const s=0;i.once("ready-to-show",()=>{setTimeout(()=>{i&&(i.show(),i.focus())},s)}),setTimeout(()=>{i&&!i.isVisible()&&(i.show(),i.focus())},5e3),i.on("closed",()=>{i=null});try{i.setVisibleOnAllWorkspaces(!0,{visibleOnFullScreen:!0})}catch{}if(!d.isPackaged||process.env.NODE_ENV==="development")i.loadURL("http://localhost:5173");else{const r=c.join(__dirname,"../renderer/main_window/index.html");i.loadFile(r)}},E=()=>{if(m){m.focus();return}if(m=new $({width:500,height:600,title:"Island Settings",autoHideMenuBar:!0,icon:P(),webPreferences:{preload:c.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0}}),!d.isPackaged||process.env.NODE_ENV==="development")m.loadURL("http://localhost:5173/settings.html");else{const e=c.join(__dirname,"../renderer/main_window/settings.html");m.loadFile(e)}m.on("closed",()=>{m=null})};d.whenReady().then(()=>{if(!d.requestSingleInstanceLock()){N.showErrorBox("Island is already running","Another instance of Island is already running. Please close it first."),d.quit();return}k(),d.on("activate",()=>{$.getAllWindows().length===0&&k()});try{const e=P();let n;e&&o.existsSync(e)?n=w.createFromPath(e).resize({width:16,height:16}):n=w.createEmpty();const t=F.buildFromTemplate([{label:"Show/Hide Island",click:()=>{i&&(i.isVisible()?i.hide():i.show())}},{label:"Settings",click:()=>{E()}},{type:"separator"},{label:"Quit",click:()=>{d.quit()}}]);v=new j(n),v.setToolTip("Island"),v.setContextMenu(t)}catch(e){console.error("Failed to create tray:",e)}});l.on("open-settings",()=>{E()});l.on("hide-island",()=>{try{i&&i.hide()}catch(e){console.error("[Main] Failed to hide island:",e)}});l.on("quit-app",()=>{try{d.quit()}catch(e){console.error("[Main] Failed to quit app:",e)}});l.handle("save-settings",async(e,n)=>{try{const t=c.join(d.getPath("documents"),"Island");o.existsSync(t)||o.mkdirSync(t,{recursive:!0});const s=c.join(t,"settings.json");return o.writeFileSync(s,JSON.stringify(n,null,2)),!0}catch(t){return console.error("Error saving settings:",t),!1}});l.handle("get-settings",async()=>{try{const e=c.join(d.getPath("documents"),"Island","settings.json");if(o.existsSync(e)){const n=o.readFileSync(e,"utf8");return JSON.parse(n)}}catch(e){console.error("Error getting settings:",e)}return{}});l.handle("change-volume",(e,n)=>(b(`powershell -NoProfile -Command "${`(New-Object -ComObject WScript.Shell).SendKeys(${n==="up"?"[char]175":"[char]174"})`}"`),null));l.handle("change-brightness",(e,n)=>new Promise(t=>{const r=`
$ErrorActionPreference = 'Stop'
$brightness = (Get-WmiObject -Namespace root/WMI -Class WmiMonitorBrightness).CurrentBrightness
$newBrightness = $brightness + ${n==="up"?10:-10}
if ($newBrightness -gt 100) { $newBrightness = 100 }
if ($newBrightness -lt 0) { $newBrightness = 0 }
(Get-WmiObject -Namespace root/WMI -Class WmiMonitorBrightnessMethods).WmiSetBrightness(1, $newBrightness) | Out-Null
Write-Output $newBrightness
`,a=c.join(d.getPath("userData"),"brightness-script.ps1");try{o.writeFileSync(a,r)}catch(u){return console.error("[Main] Failed to write brightness script:",u),t(null)}b(`powershell -NoProfile -ExecutionPolicy Bypass -File "${a}"`,{timeout:6e3},(u,f,p)=>{try{o.unlinkSync(a)}catch{}if(u)return console.error("[Main] change-brightness failed:",u.message),p&&console.error("[Main] change-brightness stderr:",p),t(null);const S=Number(String(f).trim());t(Number.isFinite(S)?S:null)})}));l.handle("save-todo",async(e,n)=>{try{const t=c.join(d.getPath("documents"),"Island");o.existsSync(t)||o.mkdirSync(t,{recursive:!0});const s=c.join(t,"todo.json");return o.writeFileSync(s,JSON.stringify(n,null,2)),!0}catch(t){return console.error("Error saving todo:",t),!1}});l.handle("get-todo",async()=>{try{const e=c.join(d.getPath("documents"),"Island","todo.json");if(o.existsSync(e)){const n=o.readFileSync(e,"utf8");return JSON.parse(n)}}catch(e){console.error("Error getting todo:",e)}return[]});l.handle("get-calendar-events",async()=>{try{const e=c.join(d.getPath("documents"),"Island","calendar-events.json");if(o.existsSync(e)){const n=o.readFileSync(e,"utf8");return JSON.parse(n)}}catch(e){console.error("Error getting calendar events:",e)}return{}});l.handle("save-calendar-events",async(e,n)=>{try{const t=c.join(d.getPath("documents"),"Island");o.existsSync(t)||o.mkdirSync(t,{recursive:!0});const s=c.join(t,"calendar-events.json");return o.writeFileSync(s,JSON.stringify(n,null,2)),!0}catch(t){return console.error("Error saving calendar events:",t),!1}});l.handle("log",(e,n)=>{console.log(`[Renderer]: ${n}`)});l.handle("get-system-media",async()=>new Promise(e=>{const n=`
$ErrorActionPreference = 'Stop'
try {
    # Load WinRT assemblies
    Add-Type -AssemblyName System.Runtime.WindowsRuntime
    [void][Windows.Media.Control.GlobalSystemMediaTransportControlsSessionManager,Windows.Media.Control,ContentType=WindowsRuntime]
    
    # Helper function to convert WinRT async to .NET Task
    $asTaskGeneric = ([System.WindowsRuntimeSystemExtensions].GetMethods() | Where-Object { 
        $_.Name -eq 'AsTask' -and 
        $_.GetParameters().Count -eq 1 -and 
        $_.GetParameters()[0].ParameterType.Name -eq 'IAsyncOperation\`1' 
    })[0]
    
    function Await($WinRtTask, $ResultType) {
        $asTask = $asTaskGeneric.MakeGenericMethod($ResultType)
        $netTask = $asTask.Invoke($null, @($WinRtTask))
        $netTask.Wait(-1) | Out-Null
        return $netTask.Result
    }
    
    # Get the session manager
    $asyncOp = [Windows.Media.Control.GlobalSystemMediaTransportControlsSessionManager]::RequestAsync()
    $manager = Await $asyncOp ([Windows.Media.Control.GlobalSystemMediaTransportControlsSessionManager])
    
    if (-not $manager) { Write-Output 'null'; exit 0 }
    
    # Find a playing session
    $sessions = $manager.GetSessions()
    $session = $null
    foreach ($s in $sessions) {
        $pb = $s.GetPlaybackInfo()
        if ($pb.PlaybackStatus -eq 'Playing') { $session = $s; break }
    }
    if (-not $session) { $session = $manager.GetCurrentSession() }
    if (-not $session) { Write-Output 'null'; exit 0 }
    
    # Get media properties
    $propsAsync = $session.TryGetMediaPropertiesAsync()
    $props = Await $propsAsync ([Windows.Media.Control.GlobalSystemMediaTransportControlsSessionMediaProperties])
    $pb = $session.GetPlaybackInfo()
    
    @{
        Title = if($props.Title) { $props.Title } else { 'Unknown' }
        Artist = if($props.Artist) { $props.Artist } else { '' }
        Album = if($props.AlbumTitle) { $props.AlbumTitle } else { '' }
        Status = $pb.PlaybackStatus.ToString().ToLower()
        Source = $session.SourceAppUserModelId
    } | ConvertTo-Json -Compress
} catch {
    Write-Host "PS Error: $_"
    Write-Output 'null'
}
`,t=c.join(d.getPath("userData"),"media-script.ps1");try{o.writeFileSync(t,n)}catch(a){return console.error("[Media] Failed to write script:",a),e(null)}const s=a=>{b("pwsh -Version",{timeout:2e3},u=>{a(!u)})},r=a=>{const u=a?"pwsh":"powershell";console.log(`[Media] Using ${u}...`),b(`${u} -NoProfile -ExecutionPolicy Bypass -File "${t}"`,{timeout:8e3},(f,p,S)=>{try{o.unlinkSync(t)}catch{}if(S&&console.log("[Media] Stderr:",S),p&&console.log("[Media] Output:",p.trim().substring(0,150)),f)return console.error("[Media] Error:",f.message),e(null);try{const T=p.trim().split(`
`).find(W=>W.trim().startsWith("{"));if(!T||T==="null")return console.log("[Media] No session found"),e(null);const g=JSON.parse(T);console.log("[Media] Found:",g.Title,"-",g.Artist);let M=g.Source||"System";M.includes(".")&&(M=M.split(".")[0]),e({name:g.Title||"Unknown Title",artist:g.Artist||"Unknown Artist",album:g.Album||"",state:g.Status==="playing"?"playing":"paused",source:M,artwork_url:null})}catch(I){console.error("[Media] Parse error:",I.message),e(null)}})};s(a=>r(a))}));l.handle("get-bluetooth-status",async()=>new Promise(e=>{b(`powershell -Command "${`
        Add-Type -AssemblyName System.Runtime.WindowsRuntime
        $devices = [Windows.Devices.Enumeration.DeviceInformation, Windows.Devices.Enumeration, ContentType = WindowsRuntime]::FindAllAsync('(System.Devices.Aep.ProtocolId:="{e0cbf06c-5021-4943-9112-460f89956c33}") AND (System.Devices.Aep.IsConnected:=$true)').GetAwaiter().GetResult()
        return $devices.Count > 0
      `.replace(/"/g,'\\"')}"`,(t,s)=>{if(t)return e(!1);e(s.trim().toLowerCase()==="true")})}));d.on("window-all-closed",()=>{d.quit()});l.handle("write-files-to-clipboard",(e,n)=>{if(!n||!Array.isArray(n))return;const t=n.filter(r=>typeof r=="string"&&r.length>0);if(t.length===0){console.log("[Main]: No valid paths to write.");return}const s=t.map(r=>c.win32.normalize(r));console.log("[Main]: WRITING TO CLIPBOARD (filenames only):",s);try{y.clear(),y.write({filenames:s})}catch(r){console.error("[Main]: Clipboard error:",r)}});l.on("ondragstart",(e,n)=>{if(console.log(`[Main] Attempting dragstart for: ${n}`),o.existsSync(n)){const t=P();let s;t&&o.existsSync(t)&&(s=w.createFromPath(t),s.isEmpty()?s=void 0:s=s.resize({width:32,height:32}));const r=c.resolve(n);console.log(`[Main] Starting OS drag for REAL file: ${r}`);try{if(!o.existsSync(r))throw new Error(`File not found: ${r}`);d.getFileIcon(r,{size:"normal"}).then(a=>{const u=$.fromWebContents(e.sender);u&&(u.setIgnoreMouseEvents(!0,{forward:!1}),u.setAlwaysOnTop(!0,"floating")),e.sender.startDrag({file:r,icon:a}),console.log(`[Main] OS acknowledged REAL file drag for: ${r}`),e.sender.once("drag-end",()=>{console.log(`[Main] Drag ended for: ${r}`),u&&!u.isDestroyed()&&(u.setAlwaysOnTop(!0,"screen-saver"),u.setIgnoreMouseEvents(!1)),e.sender.send("drag-finished",n)})}).catch(a=>{console.error("[Main] Error getting file icon:",a);const u=P(),f=u&&o.existsSync(u)?w.createFromPath(u).resize({width:32,height:32}):w.createEmpty(),p=$.fromWebContents(e.sender);p&&(p.setIgnoreMouseEvents(!0,{forward:!1}),p.setAlwaysOnTop(!0,"floating")),e.sender.startDrag({file:r,files:[r],icon:f}),p&&!p.isDestroyed()&&(p.setAlwaysOnTop(!0,"screen-saver"),p.setIgnoreMouseEvents(!1)),e.sender.send("drag-finished",n)})}catch(a){console.error("[Main] Critical error during startDrag:",a)}}else console.error(`[Main] File does not exist for drag: ${n}`)});const A=()=>{const e=c.join(d.getPath("documents"),"Island","ai_chats");return o.existsSync(e)||o.mkdirSync(e,{recursive:!0}),c.join(e,"history.json")};l.handle("save-chat-history",async(e,n)=>{try{const t=A();let s=[];if(o.existsSync(t))try{const r=o.readFileSync(t,"utf8");s=JSON.parse(r)}catch(r){console.error("Error reading chat history:",r)}return s.push({id:Date.now().toString(),timestamp:Date.now(),...n}),o.writeFileSync(t,JSON.stringify(s,null,2)),!0}catch(t){return console.error("Error saving chat history:",t),!1}});l.handle("get-chat-history",async()=>{try{const e=A();if(o.existsSync(e)){const n=o.readFileSync(e,"utf8");return JSON.parse(n)}return[]}catch(e){return console.error("Error getting chat history:",e),[]}});l.handle("clear-chat-history",async()=>{try{const e=A();return o.existsSync(e)&&o.unlinkSync(e),!0}catch(e){return console.error("Error clearing chat history:",e),!1}});let h=[];const D=50,O=()=>{const e=y.readText(),n=y.readImage();let t=null;if(n.isEmpty())e&&e.trim()&&(h.length===0||h[0].content!==e)&&(t={type:"text",content:e,timestamp:Date.now()});else{const s=n.toDataURL();(h.length===0||h[0].content!==s)&&(t={type:"image",content:s,timestamp:Date.now()})}t&&(h.unshift(t),h.length>D&&h.pop(),i&&i.webContents.send("clipboard-update",h))};setInterval(O,1e3);l.handle("get-clipboard-history",()=>h);l.handle("copy-to-clipboard",(e,{type:n,content:t})=>{if(n==="image"){const s=w.createFromDataURL(t);y.writeImage(s)}else y.writeText(t);return O(),!0});l.handle("clear-clipboard-history",()=>(h=[],y.clear(),i&&i.webContents.send("clipboard-update",h),!0));l.handle("delete-clipboard-item",(e,n)=>{const t=h.find(s=>s.timestamp===n);if(t){const s=y.readText(),r=y.readImage();let a=!1;(t.type==="text"&&t.content===s||t.type==="image"&&!r.isEmpty()&&t.content===r.toDataURL())&&(a=!0),a&&y.clear()}return h=h.filter(s=>s.timestamp!==n),i&&i.webContents.send("clipboard-update",h),!0});
