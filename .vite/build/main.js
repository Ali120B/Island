"use strict";const{app:u,BrowserWindow:w,screen:C,ipcMain:d,shell:D,Tray:O,Menu:F,nativeImage:f,clipboard:m}=require("electron"),a=require("node:path"),i=require("fs");let T=null,c=null,g=null;const{exec:S}=require("child_process");d.handle("set-ignore-mouse-events",(e,t,n)=>{c&&c.setIgnoreMouseEvents(t,{forward:n||!1})});d.handle("open-external",async(e,t)=>{await D.openExternal(t)});const $=()=>{try{const t="icon.png";if(u.isPackaged){const s=a.join(process.resourcesPath,t);if(i.existsSync(s))return s;const o=a.join(process.resourcesPath,"assets","icons",t);if(i.existsSync(o))return o}const n=u.getAppPath(),r=[a.join(n,"src","assets","icons",t),a.join(n,"assets","icons",t),a.join(__dirname,"assets","icons",t),a.join(__dirname,"..","src","assets","icons",t)];for(const s of r)try{if(i.existsSync(s))return s}catch(o){console.error(`[Main] Error checking path ${s}:`,o)}}catch(e){console.error("[Main] Error in getIconPath:",e)}},I=()=>{const e=C.getPrimaryDisplay(),{width:t,height:n}=e.size;c=new w({width:t,height:n,x:0,y:0,backgroundColor:"#00000000",transparent:!0,alwaysOnTop:!0,resizable:!1,frame:!1,thickFrame:!1,hasShadow:!1,skipTaskbar:!0,icon:$(),hiddenInMissionControl:!0,type:"toolbar",fullscreen:!1,visibleOnFullScreen:!0,webPreferences:{preload:a.join(__dirname,"preload.js"),devTools:!1},show:!1}),c.setAlwaysOnTop(!0,"screen-saver"),c.setVisibleOnAllWorkspaces(!0,{visibleOnFullScreen:!0}),c.setFullScreen(!0),c.setIgnoreMouseEvents(!0,{forward:!0});const r=0;c.once("ready-to-show",()=>{setTimeout(()=>{c&&(c.show(),c.focus())},r)}),setTimeout(()=>{c&&!c.isVisible()&&(c.show(),c.focus())},5e3),c.on("closed",()=>{c=null});try{c.setVisibleOnAllWorkspaces(!0,{visibleOnFullScreen:!0})}catch{}if(!u.isPackaged||process.env.NODE_ENV==="development")c.loadURL("http://localhost:5173");else{const s=a.join(__dirname,"../renderer/main_window/index.html");c.loadFile(s)}},W=()=>{if(g){g.focus();return}if(g=new w({width:500,height:600,title:"Island Settings",autoHideMenuBar:!0,icon:$(),webPreferences:{preload:a.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0}}),!u.isPackaged||process.env.NODE_ENV==="development")g.loadURL("http://localhost:5173/settings.html");else{const e=a.join(__dirname,"../renderer/main_window/settings.html");g.loadFile(e)}g.on("closed",()=>{g=null})};u.whenReady().then(()=>{I(),u.on("activate",()=>{w.getAllWindows().length===0&&I()});try{const e=$();let t;e&&i.existsSync(e)?t=f.createFromPath(e).resize({width:16,height:16}):t=f.createEmpty();const n=F.buildFromTemplate([{label:"Show/Hide Island",click:()=>{c&&(c.isVisible()?c.hide():c.show())}},{label:"Settings",click:()=>{W()}},{type:"separator"},{label:"Quit",click:()=>{u.quit()}}]);T=new O(t),T.setToolTip("Island"),T.setContextMenu(n)}catch(e){console.error("Failed to create tray:",e)}});d.on("open-settings",()=>{W()});d.handle("save-settings",async(e,t)=>{try{const n=a.join(u.getPath("documents"),"Island");i.existsSync(n)||i.mkdirSync(n,{recursive:!0});const r=a.join(n,"settings.json");return i.writeFileSync(r,JSON.stringify(t,null,2)),!0}catch(n){return console.error("Error saving settings:",n),!1}});d.handle("get-settings",async()=>{try{const e=a.join(u.getPath("documents"),"Island","settings.json");if(i.existsSync(e)){const t=i.readFileSync(e,"utf8");return JSON.parse(t)}}catch(e){console.error("Error getting settings:",e)}return{}});d.handle("change-volume",(e,t)=>{S(`powershell -Command "${`(New-Object -ComObject WScript.Shell).SendKeys(${t==="up"?"[char]175":"[char]174"})`}"`)});d.handle("change-brightness",(e,t)=>{S(`powershell -Command "${`
    $brightness = (Get-WmiObject -Namespace root/WMI -Class WmiMonitorBrightness).CurrentBrightness
    $newBrightness = $brightness + ${t==="up"?10:-10}
    if ($newBrightness -gt 100) { $newBrightness = 100 }
    if ($newBrightness -lt 0) { $newBrightness = 0 }
    (Get-WmiObject -Namespace root/WMI -Class WmiMonitorBrightnessMethods).WmiSetBrightness(1, $newBrightness)
  `.replace(/\n/g," ")}"`)});d.handle("save-todo",async(e,t)=>{try{const n=a.join(u.getPath("documents"),"Island");i.existsSync(n)||i.mkdirSync(n,{recursive:!0});const r=a.join(n,"todo.json");return i.writeFileSync(r,JSON.stringify(t,null,2)),!0}catch(n){return console.error("Error saving todo:",n),!1}});d.handle("get-todo",async()=>{try{const e=a.join(u.getPath("documents"),"Island","todo.json");if(i.existsSync(e)){const t=i.readFileSync(e,"utf8");return JSON.parse(t)}}catch(e){console.error("Error getting todo:",e)}return[]});d.handle("log",(e,t)=>{console.log(`[Renderer]: ${t}`)});d.handle("get-system-media",async()=>new Promise(e=>{const t=`
$ErrorActionPreference = 'Stop'
try {
    # Load WinRT assemblies
    Add-Type -AssemblyName System.Runtime.WindowsRuntime
    [void][Windows.Media.Control.GlobalSystemMediaTransportControlsSessionManager,Windows.Media.Control,ContentType=WindowsRuntime]
    
    # Helper function to convert WinRT async to .NET Task
    $asTaskGeneric = ([System.WindowsRuntimeSystemExtensions].GetMethods() | Where-Object { 
        $_.Name -eq 'AsTask' -and 
        $_.GetParameters().Count -eq 1 -and 
        $_.GetParameters()[0].ParameterType.Name -eq 'IAsyncOperation\`1' 
    })[0]
    
    function Await($WinRtTask, $ResultType) {
        $asTask = $asTaskGeneric.MakeGenericMethod($ResultType)
        $netTask = $asTask.Invoke($null, @($WinRtTask))
        $netTask.Wait(-1) | Out-Null
        return $netTask.Result
    }
    
    # Get the session manager
    $asyncOp = [Windows.Media.Control.GlobalSystemMediaTransportControlsSessionManager]::RequestAsync()
    $manager = Await $asyncOp ([Windows.Media.Control.GlobalSystemMediaTransportControlsSessionManager])
    
    if (-not $manager) { Write-Output 'null'; exit 0 }
    
    # Find a playing session
    $sessions = $manager.GetSessions()
    $session = $null
    foreach ($s in $sessions) {
        $pb = $s.GetPlaybackInfo()
        if ($pb.PlaybackStatus -eq 'Playing') { $session = $s; break }
    }
    if (-not $session) { $session = $manager.GetCurrentSession() }
    if (-not $session) { Write-Output 'null'; exit 0 }
    
    # Get media properties
    $propsAsync = $session.TryGetMediaPropertiesAsync()
    $props = Await $propsAsync ([Windows.Media.Control.GlobalSystemMediaTransportControlsSessionMediaProperties])
    $pb = $session.GetPlaybackInfo()
    
    @{
        Title = if($props.Title) { $props.Title } else { 'Unknown' }
        Artist = if($props.Artist) { $props.Artist } else { '' }
        Album = if($props.AlbumTitle) { $props.AlbumTitle } else { '' }
        Status = $pb.PlaybackStatus.ToString().ToLower()
        Source = $session.SourceAppUserModelId
    } | ConvertTo-Json -Compress
} catch {
    Write-Host "PS Error: $_"
    Write-Output 'null'
}
`,n=a.join(u.getPath("userData"),"media-script.ps1");try{i.writeFileSync(n,t)}catch(o){return console.error("[Media] Failed to write script:",o),e(null)}const r=o=>{S("pwsh -Version",{timeout:2e3},l=>{o(!l)})},s=o=>{const l=o?"pwsh":"powershell";console.log(`[Media] Using ${l}...`),S(`${l} -NoProfile -ExecutionPolicy Bypass -File "${n}"`,{timeout:8e3},(b,p,E)=>{try{i.unlinkSync(n)}catch{}if(E&&console.log("[Media] Stderr:",E),p&&console.log("[Media] Output:",p.trim().substring(0,150)),b)return console.error("[Media] Error:",b.message),e(null);try{const P=p.trim().split(`
`).find(x=>x.trim().startsWith("{"));if(!P||P==="null")return console.log("[Media] No session found"),e(null);const y=JSON.parse(P);console.log("[Media] Found:",y.Title,"-",y.Artist);let v=y.Source||"System";v.includes(".")&&(v=v.split(".")[0]),e({name:y.Title||"Unknown Title",artist:y.Artist||"Unknown Artist",album:y.Album||"",state:y.Status==="playing"?"playing":"paused",source:v,artwork_url:null})}catch(k){console.error("[Media] Parse error:",k.message),e(null)}})};r(o=>s(o))}));d.handle("get-bluetooth-status",async()=>new Promise(e=>{S(`powershell -Command "${`
        Add-Type -AssemblyName System.Runtime.WindowsRuntime
        $devices = [Windows.Devices.Enumeration.DeviceInformation, Windows.Devices.Enumeration, ContentType = WindowsRuntime]::FindAllAsync('(System.Devices.Aep.ProtocolId:="{e0cbf06c-5021-4943-9112-460f89956c33}") AND (System.Devices.Aep.IsConnected:=$true)').GetAwaiter().GetResult()
        return $devices.Count > 0
      `.replace(/"/g,'\\"')}"`,(n,r)=>{if(n)return e(!1);e(r.trim().toLowerCase()==="true")})}));u.on("window-all-closed",()=>{u.quit()});d.handle("write-files-to-clipboard",(e,t)=>{if(!t||!Array.isArray(t))return;const n=t.filter(s=>typeof s=="string"&&s.length>0);if(n.length===0){console.log("[Main]: No valid paths to write.");return}const r=n.map(s=>a.win32.normalize(s));console.log("[Main]: WRITING TO CLIPBOARD (filenames only):",r);try{m.clear(),m.write({filenames:r})}catch(s){console.error("[Main]: Clipboard error:",s)}});const M=()=>{const e=a.join(u.getPath("documents"),"Island","temp"),t=a.join(e,"copy"),n=a.join(e,"move");return[e,t,n].forEach(r=>{i.existsSync(r)||i.mkdirSync(r,{recursive:!0})}),{root:e,copyDir:t,moveDir:n}};d.handle("get-temp-files",async()=>{const{copyDir:e,moveDir:t}=M();try{const n=i.readdirSync(e).map(s=>({name:s,path:a.join(e,s),type:"copy"})),r=i.readdirSync(t).map(s=>({name:s,path:a.join(t,s),type:"move"}));return[...n,...r]}catch(n){return console.error("[Main] Error reading temp dirs:",n),[]}});d.handle("copy-to-temp",async(e,t)=>{const{copyDir:n}=M(),r=[];for(const s of t)try{const o=a.basename(s),l=a.join(n,o);i.copyFileSync(s,l),r.push({name:o,path:l,success:!0})}catch(o){console.error(`[Main] Error copying ${s}:`,o),r.push({name:a.basename(s),path:"",success:!1,error:o.message})}return r});d.handle("move-to-temp",async(e,t)=>{const{moveDir:n}=M(),r=[];for(const s of t)try{const o=a.basename(s),l=a.join(n,o);i.renameSync(s,l),r.push({name:o,path:l,success:!0})}catch(o){console.error(`[Main] Error moving ${s}:`,o),r.push({name:a.basename(s),path:"",success:!1,error:o.message})}return r});d.handle("clear-temp-files",async(e,t)=>{const{copyDir:n,moveDir:r}=M();if(t&&t.length>0)for(const s of t)try{i.existsSync(s)&&i.unlinkSync(s)}catch(o){console.error(`[Main] Error deleting ${s}:`,o)}else try{[n,r].forEach(s=>{const o=i.readdirSync(s);for(const l of o)i.unlinkSync(a.join(s,l))})}catch(s){console.error("[Main] Error clearing temp dirs:",s)}return!0});d.handle("move-from-temp",async(e,{filePaths:t,destDir:n})=>{const r=[];for(const s of t)try{const o=a.basename(s),l=a.join(n,o);i.renameSync(s,l),r.push({name:o,path:l,success:!0})}catch(o){console.error(`[Main] Error moving from temp ${s}:`,o),r.push({name:a.basename(s),path:"",success:!1,error:o.message})}return r});d.on("ondragstart",(e,t)=>{if(console.log(`[Main] Attempting dragstart for: ${t}`),i.existsSync(t)){const n=$();let r;n&&i.existsSync(n)&&(r=f.createFromPath(n),r.isEmpty()?r=void 0:r=r.resize({width:32,height:32}));const s=a.resolve(t);console.log(`[Main] Starting OS drag for REAL file: ${s}`);try{if(!i.existsSync(s))throw new Error(`File not found: ${s}`);u.getFileIcon(s,{size:"normal"}).then(o=>{const l=w.fromWebContents(e.sender);l&&(l.setIgnoreMouseEvents(!0,{forward:!1}),l.setAlwaysOnTop(!0,"floating")),e.sender.startDrag({file:s,files:[s],icon:o}),console.log(`[Main] OS acknowledged REAL file drag for: ${s}`),l&&!l.isDestroyed()&&(l.setAlwaysOnTop(!0,"screen-saver"),l.setIgnoreMouseEvents(!1)),e.sender.send("drag-finished",t)}).catch(o=>{console.error("[Main] Error getting file icon:",o);const l=$(),b=l&&i.existsSync(l)?f.createFromPath(l).resize({width:32,height:32}):f.createEmpty(),p=w.fromWebContents(e.sender);p&&(p.setIgnoreMouseEvents(!0,{forward:!1}),p.setAlwaysOnTop(!0,"floating")),e.sender.startDrag({file:s,files:[s],icon:b}),p&&!p.isDestroyed()&&(p.setAlwaysOnTop(!0,"screen-saver"),p.setIgnoreMouseEvents(!1)),e.sender.send("drag-finished",t)})}catch(o){console.error("[Main] Critical error during startDrag:",o)}}else console.error(`[Main] File does not exist for drag: ${t}`)});const A=()=>{const e=a.join(u.getPath("documents"),"Island","ai_chats");return i.existsSync(e)||i.mkdirSync(e,{recursive:!0}),a.join(e,"history.json")};d.handle("save-chat-history",async(e,t)=>{try{const n=A();let r=[];if(i.existsSync(n))try{const s=i.readFileSync(n,"utf8");r=JSON.parse(s)}catch(s){console.error("Error reading chat history:",s)}return r.push({id:Date.now().toString(),timestamp:Date.now(),...t}),i.writeFileSync(n,JSON.stringify(r,null,2)),!0}catch(n){return console.error("Error saving chat history:",n),!1}});d.handle("get-chat-history",async()=>{try{const e=A();if(i.existsSync(e)){const t=i.readFileSync(e,"utf8");return JSON.parse(t)}return[]}catch(e){return console.error("Error getting chat history:",e),[]}});d.handle("clear-chat-history",async()=>{try{const e=A();return i.existsSync(e)&&i.unlinkSync(e),!0}catch(e){return console.error("Error clearing chat history:",e),!1}});let h=[];const N=50,j=()=>{const e=m.readText(),t=m.readImage();let n=null;if(t.isEmpty())e&&e.trim()&&(h.length===0||h[0].content!==e)&&(n={type:"text",content:e,timestamp:Date.now()});else{const r=t.toDataURL();(h.length===0||h[0].content!==r)&&(n={type:"image",content:r,timestamp:Date.now()})}n&&(h.unshift(n),h.length>N&&h.pop(),c&&c.webContents.send("clipboard-update",h))};setInterval(j,1e3);d.handle("get-clipboard-history",()=>h);d.handle("copy-to-clipboard",(e,{type:t,content:n})=>{if(t==="image"){const r=f.createFromDataURL(n);m.writeImage(r)}else m.writeText(n);return j(),!0});d.handle("clear-clipboard-history",()=>(h=[],m.clear(),c&&c.webContents.send("clipboard-update",h),!0));d.handle("delete-clipboard-item",(e,t)=>{const n=h.find(r=>r.timestamp===t);if(n){const r=m.readText(),s=m.readImage();let o=!1;(n.type==="text"&&n.content===r||n.type==="image"&&!s.isEmpty()&&n.content===s.toDataURL())&&(o=!0),o&&m.clear()}return h=h.filter(r=>r.timestamp!==t),c&&c.webContents.send("clipboard-update",h),!0});
