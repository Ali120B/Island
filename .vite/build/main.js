"use strict";const{app:d,BrowserWindow:$,screen:x,ipcMain:l,shell:F,Tray:j,Menu:N,nativeImage:S,clipboard:g,dialog:D}=require("electron"),{autoUpdater:m}=require("electron-updater"),c=require("node:path"),i=require("fs");d.commandLine.appendSwitch("autoplay-policy","no-user-gesture-required");let A=null,o=null,y=null;const{exec:v}=require("child_process");l.handle("set-ignore-mouse-events",(e,n,t)=>{o&&o.setIgnoreMouseEvents(n,{forward:t||!1})});l.handle("open-external",async(e,n)=>{await F.openExternal(n)});const P=()=>{try{const n="icon.png";if(d.isPackaged){const r=c.join(process.resourcesPath,n);if(i.existsSync(r))return r;const a=c.join(process.resourcesPath,"assets","icons",n);if(i.existsSync(a))return a}const t=d.getAppPath(),s=[c.join(t,"src","assets","icons",n),c.join(t,"assets","icons",n),c.join(__dirname,"assets","icons",n),c.join(__dirname,"..","src","assets","icons",n)];for(const r of s)try{if(i.existsSync(r))return r}catch(a){console.error(`[Main] Error checking path ${r}:`,a)}}catch(e){console.error("[Main] Error in getIconPath:",e)}},E=()=>{const e=x.getPrimaryDisplay(),{width:n,height:t}=e.size;o=new $({width:n,height:t,x:0,y:0,backgroundColor:"#00000000",transparent:!0,alwaysOnTop:!0,resizable:!1,frame:!1,thickFrame:!1,hasShadow:!1,skipTaskbar:!0,icon:P(),hiddenInMissionControl:!0,type:"toolbar",fullscreen:!1,visibleOnFullScreen:!0,webPreferences:{preload:c.join(__dirname,"preload.js"),devTools:!1},show:!1}),o.setAlwaysOnTop(!0,"screen-saver"),o.setVisibleOnAllWorkspaces(!0,{visibleOnFullScreen:!0}),o.setFullScreen(!0),o.setIgnoreMouseEvents(!0,{forward:!0});const s=0;o.once("ready-to-show",()=>{setTimeout(()=>{o&&(o.show(),o.focus())},s)}),setTimeout(()=>{o&&!o.isVisible()&&(o.show(),o.focus())},5e3),o.on("closed",()=>{o=null});try{o.setVisibleOnAllWorkspaces(!0,{visibleOnFullScreen:!0})}catch{}if(!d.isPackaged||process.env.NODE_ENV==="development")o.loadURL("http://localhost:5173");else{const r=c.join(__dirname,"../renderer/main_window/index.html");o.loadFile(r)}},O=()=>{if(y){y.focus();return}if(y=new $({width:500,height:600,title:"Island Settings",autoHideMenuBar:!0,icon:P(),webPreferences:{preload:c.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0}}),!d.isPackaged||process.env.NODE_ENV==="development")y.loadURL("http://localhost:5173/settings.html");else{const e=c.join(__dirname,"../renderer/main_window/settings.html");y.loadFile(e)}y.on("closed",()=>{y=null})};d.whenReady().then(()=>{if(!d.requestSingleInstanceLock()){D.showErrorBox("Island is already running","Another instance of Island is already running. Please close it first."),d.quit();return}E(),d.isPackaged&&(m.autoDownload=!0,m.autoInstallOnAppQuit=!0,m.setFeedURL({provider:"github",owner:"Ali120B",repo:"Island"}),m.checkForUpdatesAndNotify(),setInterval(()=>{m.checkForUpdatesAndNotify()},60*60*1e3),m.on("update-available",e=>{console.log("[Updater] Update available:",e.version),y&&y.webContents.send("update-available",e.version),o&&o.webContents.send("update-available",e.version)}),m.on("update-downloaded",e=>{console.log("[Updater] Update downloaded:",e.version),y&&y.webContents.send("update-downloaded",e.version),o&&o.webContents.send("update-downloaded",e.version)}),m.on("error",e=>{console.error("[Updater] Error:",e)})),d.on("activate",()=>{$.getAllWindows().length===0&&E()});try{const e=P();let n;e&&i.existsSync(e)?n=S.createFromPath(e).resize({width:16,height:16}):n=S.createEmpty();const t=N.buildFromTemplate([{label:"Show/Hide Island",click:()=>{o&&(o.isVisible()?o.hide():o.show())}},{label:"Settings",click:()=>{O()}},{type:"separator"},{label:"Quit",click:()=>{d.quit()}}]);A=new j(n),A.setToolTip("Island"),A.setContextMenu(t)}catch(e){console.error("Failed to create tray:",e)}});l.on("open-settings",()=>{O()});l.on("quit-and-install",()=>{m.quitAndInstall(!1,!0)});l.on("hide-island",()=>{try{o&&o.hide()}catch(e){console.error("[Main] Failed to hide island:",e)}});l.on("quit-app",()=>{try{d.quit()}catch(e){console.error("[Main] Failed to quit app:",e)}});l.handle("save-settings",async(e,n)=>{try{const t=c.join(d.getPath("documents"),"Island");i.existsSync(t)||i.mkdirSync(t,{recursive:!0});const s=c.join(t,"settings.json");return i.writeFileSync(s,JSON.stringify(n,null,2)),!0}catch(t){return console.error("Error saving settings:",t),!1}});l.handle("get-settings",async()=>{try{const e=c.join(d.getPath("documents"),"Island","settings.json");if(i.existsSync(e)){const n=i.readFileSync(e,"utf8");return JSON.parse(n)}}catch(e){console.error("Error getting settings:",e)}return{}});l.handle("change-volume",(e,n)=>(v(`powershell -NoProfile -Command "${`(New-Object -ComObject WScript.Shell).SendKeys(${n==="up"?"[char]175":"[char]174"})`}"`),null));l.handle("change-brightness",(e,n)=>new Promise(t=>{const r=`
$ErrorActionPreference = 'Stop'
$brightness = (Get-WmiObject -Namespace root/WMI -Class WmiMonitorBrightness).CurrentBrightness
$newBrightness = $brightness + ${n==="up"?10:-10}
if ($newBrightness -gt 100) { $newBrightness = 100 }
if ($newBrightness -lt 0) { $newBrightness = 0 }
(Get-WmiObject -Namespace root/WMI -Class WmiMonitorBrightnessMethods).WmiSetBrightness(1, $newBrightness) | Out-Null
Write-Output $newBrightness
`,a=c.join(d.getPath("userData"),"brightness-script.ps1");try{i.writeFileSync(a,r)}catch(u){return console.error("[Main] Failed to write brightness script:",u),t(null)}v(`powershell -NoProfile -ExecutionPolicy Bypass -File "${a}"`,{timeout:6e3},(u,w,p)=>{try{i.unlinkSync(a)}catch{}if(u)return console.error("[Main] change-brightness failed:",u.message),p&&console.error("[Main] change-brightness stderr:",p),t(null);const b=Number(String(w).trim());t(Number.isFinite(b)?b:null)})}));l.handle("save-todo",async(e,n)=>{try{const t=c.join(d.getPath("documents"),"Island");i.existsSync(t)||i.mkdirSync(t,{recursive:!0});const s=c.join(t,"todo.json");return i.writeFileSync(s,JSON.stringify(n,null,2)),!0}catch(t){return console.error("Error saving todo:",t),!1}});l.handle("get-todo",async()=>{try{const e=c.join(d.getPath("documents"),"Island","todo.json");if(i.existsSync(e)){const n=i.readFileSync(e,"utf8");return JSON.parse(n)}}catch(e){console.error("Error getting todo:",e)}return[]});l.handle("get-calendar-events",async()=>{try{const e=c.join(d.getPath("documents"),"Island","calendar-events.json");if(i.existsSync(e)){const n=i.readFileSync(e,"utf8");return JSON.parse(n)}}catch(e){console.error("Error getting calendar events:",e)}return{}});l.handle("save-calendar-events",async(e,n)=>{try{const t=c.join(d.getPath("documents"),"Island");i.existsSync(t)||i.mkdirSync(t,{recursive:!0});const s=c.join(t,"calendar-events.json");return i.writeFileSync(s,JSON.stringify(n,null,2)),!0}catch(t){return console.error("Error saving calendar events:",t),!1}});l.handle("log",(e,n)=>{console.log(`[Renderer]: ${n}`)});l.handle("get-system-media",async()=>new Promise(e=>{const n=`
$ErrorActionPreference = 'Stop'
try {
    # Load WinRT assemblies
    Add-Type -AssemblyName System.Runtime.WindowsRuntime
    [void][Windows.Media.Control.GlobalSystemMediaTransportControlsSessionManager,Windows.Media.Control,ContentType=WindowsRuntime]
    
    # Helper function to convert WinRT async to .NET Task
    $asTaskGeneric = ([System.WindowsRuntimeSystemExtensions].GetMethods() | Where-Object { 
        $_.Name -eq 'AsTask' -and 
        $_.GetParameters().Count -eq 1 -and 
        $_.GetParameters()[0].ParameterType.Name -eq 'IAsyncOperation\`1' 
    })[0]
    
    function Await($WinRtTask, $ResultType) {
        $asTask = $asTaskGeneric.MakeGenericMethod($ResultType)
        $netTask = $asTask.Invoke($null, @($WinRtTask))
        $netTask.Wait(-1) | Out-Null
        return $netTask.Result
    }
    
    # Get the session manager
    $asyncOp = [Windows.Media.Control.GlobalSystemMediaTransportControlsSessionManager]::RequestAsync()
    $manager = Await $asyncOp ([Windows.Media.Control.GlobalSystemMediaTransportControlsSessionManager])
    
    if (-not $manager) { Write-Output 'null'; exit 0 }
    
    # Find a playing session
    $sessions = $manager.GetSessions()
    $session = $null
    foreach ($s in $sessions) {
        $pb = $s.GetPlaybackInfo()
        if ($pb.PlaybackStatus -eq 'Playing') { $session = $s; break }
    }
    if (-not $session) { $session = $manager.GetCurrentSession() }
    if (-not $session) { Write-Output 'null'; exit 0 }
    
    # Get media properties
    $propsAsync = $session.TryGetMediaPropertiesAsync()
    $props = Await $propsAsync ([Windows.Media.Control.GlobalSystemMediaTransportControlsSessionMediaProperties])
    $pb = $session.GetPlaybackInfo()
    
    @{
        Title = if($props.Title) { $props.Title } else { 'Unknown' }
        Artist = if($props.Artist) { $props.Artist } else { '' }
        Album = if($props.AlbumTitle) { $props.AlbumTitle } else { '' }
        Status = $pb.PlaybackStatus.ToString().ToLower()
        Source = $session.SourceAppUserModelId
    } | ConvertTo-Json -Compress
} catch {
    Write-Host "PS Error: $_"
    Write-Output 'null'
}
`,t=c.join(d.getPath("userData"),"media-script.ps1");try{i.writeFileSync(t,n)}catch(a){return console.error("[Media] Failed to write script:",a),e(null)}const s=a=>{v("pwsh -Version",{timeout:2e3},u=>{a(!u)})},r=a=>{const u=a?"pwsh":"powershell";console.log(`[Media] Using ${u}...`),v(`${u} -NoProfile -ExecutionPolicy Bypass -File "${t}"`,{timeout:8e3},(w,p,b)=>{try{i.unlinkSync(t)}catch{}if(b&&console.log("[Media] Stderr:",b),p&&console.log("[Media] Output:",p.trim().substring(0,150)),w)return console.error("[Media] Error:",w.message),e(null);try{const T=p.trim().split(`
`).find(W=>W.trim().startsWith("{"));if(!T||T==="null")return console.log("[Media] No session found"),e(null);const f=JSON.parse(T);console.log("[Media] Found:",f.Title,"-",f.Artist);let M=f.Source||"System";M.includes(".")&&(M=M.split(".")[0]),e({name:f.Title||"Unknown Title",artist:f.Artist||"Unknown Artist",album:f.Album||"",state:f.Status==="playing"?"playing":"paused",source:M,artwork_url:null})}catch(k){console.error("[Media] Parse error:",k.message),e(null)}})};s(a=>r(a))}));l.handle("get-bluetooth-status",async()=>new Promise(e=>{v(`powershell -Command "${`
        Add-Type -AssemblyName System.Runtime.WindowsRuntime
        $devices = [Windows.Devices.Enumeration.DeviceInformation, Windows.Devices.Enumeration, ContentType = WindowsRuntime]::FindAllAsync('(System.Devices.Aep.ProtocolId:="{e0cbf06c-5021-4943-9112-460f89956c33}") AND (System.Devices.Aep.IsConnected:=$true)').GetAwaiter().GetResult()
        return $devices.Count > 0
      `.replace(/"/g,'\\"')}"`,(t,s)=>{if(t)return e(!1);e(s.trim().toLowerCase()==="true")})}));d.on("window-all-closed",()=>{d.quit()});l.handle("write-files-to-clipboard",(e,n)=>{if(!n||!Array.isArray(n))return;const t=n.filter(r=>typeof r=="string"&&r.length>0);if(t.length===0){console.log("[Main]: No valid paths to write.");return}const s=t.map(r=>c.win32.normalize(r));console.log("[Main]: WRITING TO CLIPBOARD (filenames only):",s);try{g.clear(),g.write({filenames:s})}catch(r){console.error("[Main]: Clipboard error:",r)}});l.on("ondragstart",(e,n)=>{if(console.log(`[Main] Attempting dragstart for: ${n}`),i.existsSync(n)){const t=P();let s;t&&i.existsSync(t)&&(s=S.createFromPath(t),s.isEmpty()?s=void 0:s=s.resize({width:32,height:32}));const r=c.resolve(n);console.log(`[Main] Starting OS drag for REAL file: ${r}`);try{if(!i.existsSync(r))throw new Error(`File not found: ${r}`);d.getFileIcon(r,{size:"normal"}).then(a=>{const u=$.fromWebContents(e.sender);u&&(u.setIgnoreMouseEvents(!0,{forward:!1}),u.setAlwaysOnTop(!0,"floating")),e.sender.startDrag({file:r,icon:a}),console.log(`[Main] OS acknowledged REAL file drag for: ${r}`),e.sender.once("drag-end",()=>{console.log(`[Main] Drag ended for: ${r}`),u&&!u.isDestroyed()&&(u.setAlwaysOnTop(!0,"screen-saver"),u.setIgnoreMouseEvents(!1)),e.sender.send("drag-finished",n)})}).catch(a=>{console.error("[Main] Error getting file icon:",a);const u=P(),w=u&&i.existsSync(u)?S.createFromPath(u).resize({width:32,height:32}):S.createEmpty(),p=$.fromWebContents(e.sender);p&&(p.setIgnoreMouseEvents(!0,{forward:!1}),p.setAlwaysOnTop(!0,"floating")),e.sender.startDrag({file:r,files:[r],icon:w}),p&&!p.isDestroyed()&&(p.setAlwaysOnTop(!0,"screen-saver"),p.setIgnoreMouseEvents(!1)),e.sender.send("drag-finished",n)})}catch(a){console.error("[Main] Critical error during startDrag:",a)}}else console.error(`[Main] File does not exist for drag: ${n}`)});const I=()=>{const e=c.join(d.getPath("documents"),"Island","ai_chats");return i.existsSync(e)||i.mkdirSync(e,{recursive:!0}),c.join(e,"history.json")};l.handle("save-chat-history",async(e,n)=>{try{const t=I();let s=[];if(i.existsSync(t))try{const r=i.readFileSync(t,"utf8");s=JSON.parse(r)}catch(r){console.error("Error reading chat history:",r)}return s.push({id:Date.now().toString(),timestamp:Date.now(),...n}),i.writeFileSync(t,JSON.stringify(s,null,2)),!0}catch(t){return console.error("Error saving chat history:",t),!1}});l.handle("get-chat-history",async()=>{try{const e=I();if(i.existsSync(e)){const n=i.readFileSync(e,"utf8");return JSON.parse(n)}return[]}catch(e){return console.error("Error getting chat history:",e),[]}});l.handle("clear-chat-history",async()=>{try{const e=I();return i.existsSync(e)&&i.unlinkSync(e),!0}catch(e){return console.error("Error clearing chat history:",e),!1}});let h=[];const R=50,C=()=>{const e=g.readText(),n=g.readImage();let t=null;if(n.isEmpty())e&&e.trim()&&(h.length===0||h[0].content!==e)&&(t={type:"text",content:e,timestamp:Date.now()});else{const s=n.toDataURL();(h.length===0||h[0].content!==s)&&(t={type:"image",content:s,timestamp:Date.now()})}t&&(h.unshift(t),h.length>R&&h.pop(),o&&o.webContents.send("clipboard-update",h))};setInterval(C,1e3);l.handle("get-clipboard-history",()=>h);l.handle("copy-to-clipboard",(e,{type:n,content:t})=>{if(n==="image"){const s=S.createFromDataURL(t);g.writeImage(s)}else g.writeText(t);return C(),!0});l.handle("clear-clipboard-history",()=>(h=[],g.clear(),o&&o.webContents.send("clipboard-update",h),!0));l.handle("delete-clipboard-item",(e,n)=>{const t=h.find(s=>s.timestamp===n);if(t){const s=g.readText(),r=g.readImage();let a=!1;(t.type==="text"&&t.content===s||t.type==="image"&&!r.isEmpty()&&t.content===r.toDataURL())&&(a=!0),a&&g.clear()}return h=h.filter(s=>s.timestamp!==n),o&&o.webContents.send("clipboard-update",h),!0});
