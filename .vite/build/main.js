"use strict";const{app:u,BrowserWindow:$,screen:W,ipcMain:d,shell:D,Tray:F,Menu:C,nativeImage:w,clipboard:y,dialog:N}=require("electron"),a=require("node:path"),i=require("fs");u.commandLine.appendSwitch("autoplay-policy","no-user-gesture-required");let E=null,l=null,g=null;const{exec:b}=require("child_process");d.handle("set-ignore-mouse-events",(e,n,t)=>{l&&l.setIgnoreMouseEvents(n,{forward:t||!1})});d.handle("open-external",async(e,n)=>{await D.openExternal(n)});const v=()=>{try{const n="icon.png";if(u.isPackaged){const r=a.join(process.resourcesPath,n);if(i.existsSync(r))return r;const o=a.join(process.resourcesPath,"assets","icons",n);if(i.existsSync(o))return o}const t=u.getAppPath(),s=[a.join(t,"src","assets","icons",n),a.join(t,"assets","icons",n),a.join(__dirname,"assets","icons",n),a.join(__dirname,"..","src","assets","icons",n)];for(const r of s)try{if(i.existsSync(r))return r}catch(o){console.error(`[Main] Error checking path ${r}:`,o)}}catch(e){console.error("[Main] Error in getIconPath:",e)}},I=()=>{const e=W.getPrimaryDisplay(),{width:n,height:t}=e.size;l=new $({width:n,height:t,x:0,y:0,backgroundColor:"#00000000",transparent:!0,alwaysOnTop:!0,resizable:!1,frame:!1,thickFrame:!1,hasShadow:!1,skipTaskbar:!0,icon:v(),hiddenInMissionControl:!0,type:"toolbar",fullscreen:!1,visibleOnFullScreen:!0,webPreferences:{preload:a.join(__dirname,"preload.js"),devTools:!1},show:!1}),l.setAlwaysOnTop(!0,"screen-saver"),l.setVisibleOnAllWorkspaces(!0,{visibleOnFullScreen:!0}),l.setFullScreen(!0),l.setIgnoreMouseEvents(!0,{forward:!0});const s=0;l.once("ready-to-show",()=>{setTimeout(()=>{l&&(l.show(),l.focus())},s)}),setTimeout(()=>{l&&!l.isVisible()&&(l.show(),l.focus())},5e3),l.on("closed",()=>{l=null});try{l.setVisibleOnAllWorkspaces(!0,{visibleOnFullScreen:!0})}catch{}if(!u.isPackaged||process.env.NODE_ENV==="development")l.loadURL("http://localhost:5173");else{const r=a.join(__dirname,"../renderer/main_window/index.html");l.loadFile(r)}},j=()=>{if(g){g.focus();return}if(g=new $({width:500,height:600,title:"Island Settings",autoHideMenuBar:!0,icon:v(),webPreferences:{preload:a.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0}}),!u.isPackaged||process.env.NODE_ENV==="development")g.loadURL("http://localhost:5173/settings.html");else{const e=a.join(__dirname,"../renderer/main_window/settings.html");g.loadFile(e)}g.on("closed",()=>{g=null})};u.whenReady().then(()=>{if(!u.requestSingleInstanceLock()){N.showErrorBox("Island is already running","Another instance of Island is already running. Please close it first."),u.quit();return}I(),u.on("activate",()=>{$.getAllWindows().length===0&&I()});try{const e=v();let n;e&&i.existsSync(e)?n=w.createFromPath(e).resize({width:16,height:16}):n=w.createEmpty();const t=C.buildFromTemplate([{label:"Show/Hide Island",click:()=>{l&&(l.isVisible()?l.hide():l.show())}},{label:"Settings",click:()=>{j()}},{type:"separator"},{label:"Quit",click:()=>{u.quit()}}]);E=new F(n),E.setToolTip("Island"),E.setContextMenu(t)}catch(e){console.error("Failed to create tray:",e)}});d.on("open-settings",()=>{j()});d.on("hide-island",()=>{try{l&&l.hide()}catch(e){console.error("[Main] Failed to hide island:",e)}});d.on("quit-app",()=>{try{u.quit()}catch(e){console.error("[Main] Failed to quit app:",e)}});d.handle("save-settings",async(e,n)=>{try{const t=a.join(u.getPath("documents"),"Island");i.existsSync(t)||i.mkdirSync(t,{recursive:!0});const s=a.join(t,"settings.json");return i.writeFileSync(s,JSON.stringify(n,null,2)),!0}catch(t){return console.error("Error saving settings:",t),!1}});d.handle("get-settings",async()=>{try{const e=a.join(u.getPath("documents"),"Island","settings.json");if(i.existsSync(e)){const n=i.readFileSync(e,"utf8");return JSON.parse(n)}}catch(e){console.error("Error getting settings:",e)}return{}});d.handle("change-volume",(e,n)=>(b(`powershell -NoProfile -Command "${`(New-Object -ComObject WScript.Shell).SendKeys(${n==="up"?"[char]175":"[char]174"})`}"`),null));d.handle("change-brightness",(e,n)=>new Promise(t=>{const r=`
$ErrorActionPreference = 'Stop'
$brightness = (Get-WmiObject -Namespace root/WMI -Class WmiMonitorBrightness).CurrentBrightness
$newBrightness = $brightness + ${n==="up"?10:-10}
if ($newBrightness -gt 100) { $newBrightness = 100 }
if ($newBrightness -lt 0) { $newBrightness = 0 }
(Get-WmiObject -Namespace root/WMI -Class WmiMonitorBrightnessMethods).WmiSetBrightness(1, $newBrightness) | Out-Null
Write-Output $newBrightness
`,o=a.join(u.getPath("userData"),"brightness-script.ps1");try{i.writeFileSync(o,r)}catch(c){return console.error("[Main] Failed to write brightness script:",c),t(null)}b(`powershell -NoProfile -ExecutionPolicy Bypass -File "${o}"`,{timeout:6e3},(c,f,p)=>{try{i.unlinkSync(o)}catch{}if(c)return console.error("[Main] change-brightness failed:",c.message),p&&console.error("[Main] change-brightness stderr:",p),t(null);const S=Number(String(f).trim());t(Number.isFinite(S)?S:null)})}));d.handle("save-todo",async(e,n)=>{try{const t=a.join(u.getPath("documents"),"Island");i.existsSync(t)||i.mkdirSync(t,{recursive:!0});const s=a.join(t,"todo.json");return i.writeFileSync(s,JSON.stringify(n,null,2)),!0}catch(t){return console.error("Error saving todo:",t),!1}});d.handle("get-todo",async()=>{try{const e=a.join(u.getPath("documents"),"Island","todo.json");if(i.existsSync(e)){const n=i.readFileSync(e,"utf8");return JSON.parse(n)}}catch(e){console.error("Error getting todo:",e)}return[]});d.handle("get-calendar-events",async()=>{try{const e=a.join(u.getPath("documents"),"Island","calendar-events.json");if(i.existsSync(e)){const n=i.readFileSync(e,"utf8");return JSON.parse(n)}}catch(e){console.error("Error getting calendar events:",e)}return{}});d.handle("save-calendar-events",async(e,n)=>{try{const t=a.join(u.getPath("documents"),"Island");i.existsSync(t)||i.mkdirSync(t,{recursive:!0});const s=a.join(t,"calendar-events.json");return i.writeFileSync(s,JSON.stringify(n,null,2)),!0}catch(t){return console.error("Error saving calendar events:",t),!1}});d.handle("log",(e,n)=>{console.log(`[Renderer]: ${n}`)});d.handle("get-system-media",async()=>new Promise(e=>{const n=`
$ErrorActionPreference = 'Stop'
try {
    # Load WinRT assemblies
    Add-Type -AssemblyName System.Runtime.WindowsRuntime
    [void][Windows.Media.Control.GlobalSystemMediaTransportControlsSessionManager,Windows.Media.Control,ContentType=WindowsRuntime]
    
    # Helper function to convert WinRT async to .NET Task
    $asTaskGeneric = ([System.WindowsRuntimeSystemExtensions].GetMethods() | Where-Object { 
        $_.Name -eq 'AsTask' -and 
        $_.GetParameters().Count -eq 1 -and 
        $_.GetParameters()[0].ParameterType.Name -eq 'IAsyncOperation\`1' 
    })[0]
    
    function Await($WinRtTask, $ResultType) {
        $asTask = $asTaskGeneric.MakeGenericMethod($ResultType)
        $netTask = $asTask.Invoke($null, @($WinRtTask))
        $netTask.Wait(-1) | Out-Null
        return $netTask.Result
    }
    
    # Get the session manager
    $asyncOp = [Windows.Media.Control.GlobalSystemMediaTransportControlsSessionManager]::RequestAsync()
    $manager = Await $asyncOp ([Windows.Media.Control.GlobalSystemMediaTransportControlsSessionManager])
    
    if (-not $manager) { Write-Output 'null'; exit 0 }
    
    # Find a playing session
    $sessions = $manager.GetSessions()
    $session = $null
    foreach ($s in $sessions) {
        $pb = $s.GetPlaybackInfo()
        if ($pb.PlaybackStatus -eq 'Playing') { $session = $s; break }
    }
    if (-not $session) { $session = $manager.GetCurrentSession() }
    if (-not $session) { Write-Output 'null'; exit 0 }
    
    # Get media properties
    $propsAsync = $session.TryGetMediaPropertiesAsync()
    $props = Await $propsAsync ([Windows.Media.Control.GlobalSystemMediaTransportControlsSessionMediaProperties])
    $pb = $session.GetPlaybackInfo()
    
    @{
        Title = if($props.Title) { $props.Title } else { 'Unknown' }
        Artist = if($props.Artist) { $props.Artist } else { '' }
        Album = if($props.AlbumTitle) { $props.AlbumTitle } else { '' }
        Status = $pb.PlaybackStatus.ToString().ToLower()
        Source = $session.SourceAppUserModelId
    } | ConvertTo-Json -Compress
} catch {
    Write-Host "PS Error: $_"
    Write-Output 'null'
}
`,t=a.join(u.getPath("userData"),"media-script.ps1");try{i.writeFileSync(t,n)}catch(o){return console.error("[Media] Failed to write script:",o),e(null)}const s=o=>{b("pwsh -Version",{timeout:2e3},c=>{o(!c)})},r=o=>{const c=o?"pwsh":"powershell";console.log(`[Media] Using ${c}...`),b(`${c} -NoProfile -ExecutionPolicy Bypass -File "${t}"`,{timeout:8e3},(f,p,S)=>{try{i.unlinkSync(t)}catch{}if(S&&console.log("[Media] Stderr:",S),p&&console.log("[Media] Output:",p.trim().substring(0,150)),f)return console.error("[Media] Error:",f.message),e(null);try{const T=p.trim().split(`
`).find(O=>O.trim().startsWith("{"));if(!T||T==="null")return console.log("[Media] No session found"),e(null);const m=JSON.parse(T);console.log("[Media] Found:",m.Title,"-",m.Artist);let P=m.Source||"System";P.includes(".")&&(P=P.split(".")[0]),e({name:m.Title||"Unknown Title",artist:m.Artist||"Unknown Artist",album:m.Album||"",state:m.Status==="playing"?"playing":"paused",source:P,artwork_url:null})}catch(A){console.error("[Media] Parse error:",A.message),e(null)}})};s(o=>r(o))}));d.handle("get-bluetooth-status",async()=>new Promise(e=>{b(`powershell -Command "${`
        Add-Type -AssemblyName System.Runtime.WindowsRuntime
        $devices = [Windows.Devices.Enumeration.DeviceInformation, Windows.Devices.Enumeration, ContentType = WindowsRuntime]::FindAllAsync('(System.Devices.Aep.ProtocolId:="{e0cbf06c-5021-4943-9112-460f89956c33}") AND (System.Devices.Aep.IsConnected:=$true)').GetAwaiter().GetResult()
        return $devices.Count > 0
      `.replace(/"/g,'\\"')}"`,(t,s)=>{if(t)return e(!1);e(s.trim().toLowerCase()==="true")})}));u.on("window-all-closed",()=>{u.quit()});d.handle("write-files-to-clipboard",(e,n)=>{if(!n||!Array.isArray(n))return;const t=n.filter(r=>typeof r=="string"&&r.length>0);if(t.length===0){console.log("[Main]: No valid paths to write.");return}const s=t.map(r=>a.win32.normalize(r));console.log("[Main]: WRITING TO CLIPBOARD (filenames only):",s);try{y.clear(),y.write({filenames:s})}catch(r){console.error("[Main]: Clipboard error:",r)}});const M=()=>{const e=a.join(u.getPath("documents"),"Island","temp"),n=a.join(e,"copy"),t=a.join(e,"move");return[e,n,t].forEach(s=>{i.existsSync(s)||i.mkdirSync(s,{recursive:!0})}),{root:e,copyDir:n,moveDir:t}};d.handle("get-temp-files",async()=>{const{copyDir:e,moveDir:n}=M();try{const t=i.readdirSync(e).map(r=>({name:r,path:a.join(e,r),type:"copy"})),s=i.readdirSync(n).map(r=>({name:r,path:a.join(n,r),type:"move"}));return[...t,...s]}catch(t){return console.error("[Main] Error reading temp dirs:",t),[]}});d.handle("copy-to-temp",async(e,n)=>{const{copyDir:t}=M(),s=[];for(const r of n)try{const o=a.basename(r),c=a.join(t,o);i.copyFileSync(r,c),s.push({name:o,path:c,success:!0})}catch(o){console.error(`[Main] Error copying ${r}:`,o),s.push({name:a.basename(r),path:"",success:!1,error:o.message})}return s});d.handle("move-to-temp",async(e,n)=>{const{moveDir:t}=M(),s=[];for(const r of n)try{const o=a.basename(r),c=a.join(t,o);i.renameSync(r,c),s.push({name:o,path:c,success:!0})}catch(o){console.error(`[Main] Error moving ${r}:`,o),s.push({name:a.basename(r),path:"",success:!1,error:o.message})}return s});d.handle("clear-temp-files",async(e,n)=>{const{copyDir:t,moveDir:s}=M();if(n&&n.length>0)for(const r of n)try{i.existsSync(r)&&i.unlinkSync(r)}catch(o){console.error(`[Main] Error deleting ${r}:`,o)}else try{[t,s].forEach(r=>{const o=i.readdirSync(r);for(const c of o)i.unlinkSync(a.join(r,c))})}catch(r){console.error("[Main] Error clearing temp dirs:",r)}return!0});d.handle("move-from-temp",async(e,{filePaths:n,destDir:t})=>{const s=[];for(const r of n)try{const o=a.basename(r),c=a.join(t,o);i.renameSync(r,c),s.push({name:o,path:c,success:!0})}catch(o){console.error(`[Main] Error moving from temp ${r}:`,o),s.push({name:a.basename(r),path:"",success:!1,error:o.message})}return s});d.on("ondragstart",(e,n)=>{if(console.log(`[Main] Attempting dragstart for: ${n}`),i.existsSync(n)){const t=v();let s;t&&i.existsSync(t)&&(s=w.createFromPath(t),s.isEmpty()?s=void 0:s=s.resize({width:32,height:32}));const r=a.resolve(n);console.log(`[Main] Starting OS drag for REAL file: ${r}`);try{if(!i.existsSync(r))throw new Error(`File not found: ${r}`);u.getFileIcon(r,{size:"normal"}).then(o=>{const c=$.fromWebContents(e.sender);c&&(c.setIgnoreMouseEvents(!0,{forward:!1}),c.setAlwaysOnTop(!0,"floating")),e.sender.startDrag({file:r,files:[r],icon:o}),console.log(`[Main] OS acknowledged REAL file drag for: ${r}`),c&&!c.isDestroyed()&&(c.setAlwaysOnTop(!0,"screen-saver"),c.setIgnoreMouseEvents(!1)),e.sender.send("drag-finished",n)}).catch(o=>{console.error("[Main] Error getting file icon:",o);const c=v(),f=c&&i.existsSync(c)?w.createFromPath(c).resize({width:32,height:32}):w.createEmpty(),p=$.fromWebContents(e.sender);p&&(p.setIgnoreMouseEvents(!0,{forward:!1}),p.setAlwaysOnTop(!0,"floating")),e.sender.startDrag({file:r,files:[r],icon:f}),p&&!p.isDestroyed()&&(p.setAlwaysOnTop(!0,"screen-saver"),p.setIgnoreMouseEvents(!1)),e.sender.send("drag-finished",n)})}catch(o){console.error("[Main] Critical error during startDrag:",o)}}else console.error(`[Main] File does not exist for drag: ${n}`)});const k=()=>{const e=a.join(u.getPath("documents"),"Island","ai_chats");return i.existsSync(e)||i.mkdirSync(e,{recursive:!0}),a.join(e,"history.json")};d.handle("save-chat-history",async(e,n)=>{try{const t=k();let s=[];if(i.existsSync(t))try{const r=i.readFileSync(t,"utf8");s=JSON.parse(r)}catch(r){console.error("Error reading chat history:",r)}return s.push({id:Date.now().toString(),timestamp:Date.now(),...n}),i.writeFileSync(t,JSON.stringify(s,null,2)),!0}catch(t){return console.error("Error saving chat history:",t),!1}});d.handle("get-chat-history",async()=>{try{const e=k();if(i.existsSync(e)){const n=i.readFileSync(e,"utf8");return JSON.parse(n)}return[]}catch(e){return console.error("Error getting chat history:",e),[]}});d.handle("clear-chat-history",async()=>{try{const e=k();return i.existsSync(e)&&i.unlinkSync(e),!0}catch(e){return console.error("Error clearing chat history:",e),!1}});let h=[];const R=50,x=()=>{const e=y.readText(),n=y.readImage();let t=null;if(n.isEmpty())e&&e.trim()&&(h.length===0||h[0].content!==e)&&(t={type:"text",content:e,timestamp:Date.now()});else{const s=n.toDataURL();(h.length===0||h[0].content!==s)&&(t={type:"image",content:s,timestamp:Date.now()})}t&&(h.unshift(t),h.length>R&&h.pop(),l&&l.webContents.send("clipboard-update",h))};setInterval(x,1e3);d.handle("get-clipboard-history",()=>h);d.handle("copy-to-clipboard",(e,{type:n,content:t})=>{if(n==="image"){const s=w.createFromDataURL(t);y.writeImage(s)}else y.writeText(t);return x(),!0});d.handle("clear-clipboard-history",()=>(h=[],y.clear(),l&&l.webContents.send("clipboard-update",h),!0));d.handle("delete-clipboard-item",(e,n)=>{const t=h.find(s=>s.timestamp===n);if(t){const s=y.readText(),r=y.readImage();let o=!1;(t.type==="text"&&t.content===s||t.type==="image"&&!r.isEmpty()&&t.content===r.toDataURL())&&(o=!0),o&&y.clear()}return h=h.filter(s=>s.timestamp!==n),l&&l.webContents.send("clipboard-update",h),!0});
